<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üóëÔ∏è Nh·∫Øc ƒê·ªï R√°c - L·∫Øc X√≠ Ng·∫ßu</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Animate.css -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dice-container {
            perspective: 2000px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .dice {
            font-size: 100px;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            user-select: none;
            position: relative;
            display: inline-block;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }
        
        .dice:hover {
            transform: scale(1.15) translateY(-5px);
            filter: drop-shadow(0 15px 30px rgba(0,0,0,0.4));
        }
        
        .dice.rolling {
            animation: roll3d 0.15s ease-in-out infinite, bounce 0.6s ease-in-out infinite;
        }
        
        @keyframes roll3d {
            0% { 
                transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1);
            }
            25% { 
                transform: rotateX(90deg) rotateY(180deg) rotateZ(90deg) scale(1.1);
            }
            50% { 
                transform: rotateX(180deg) rotateY(360deg) rotateZ(180deg) scale(1.2);
            }
            75% { 
                transform: rotateX(270deg) rotateY(540deg) rotateZ(270deg) scale(1.1);
            }
            100% { 
                transform: rotateX(360deg) rotateY(720deg) rotateZ(360deg) scale(1);
            }
        }
        
        @keyframes bounce {
            0%, 100% { 
                transform: translateY(0px);
                filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            }
            25% {
                transform: translateY(-40px);
                filter: drop-shadow(0 50px 40px rgba(0,0,0,0.2));
            }
            50% { 
                transform: translateY(-60px);
                filter: drop-shadow(0 70px 50px rgba(0,0,0,0.15));
            }
            75% {
                transform: translateY(-40px);
                filter: drop-shadow(0 50px 40px rgba(0,0,0,0.2));
            }
        }
        
        .selected-person {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .member-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        
        .member-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }
        
        .btn-roll {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            font-size: 1.5rem;
            padding: 15px 50px;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-roll:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.5);
            color: white;
        }
        
        .btn-roll:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-confirm {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            font-size: 1.3rem;
            padding: 12px 40px;
            border-radius: 50px;
            color: white;
            font-weight: bold;
        }
        
        .btn-confirm:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(56, 239, 125, 0.5);
            color: white;
        }
        
        .history-badge {
            font-size: 0.8rem;
        }
        
        .status-waiting {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }
        
        .status-pending {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }
        
        .reminder-level-1 { color: #ffc107; }
        .reminder-level-2 { color: #fd7e14; }
        .reminder-level-3 { color: #dc3545; }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .slot-machine {
            overflow: hidden;
            height: 80px;
            position: relative;
        }
        
        .slot-names {
            transition: transform 0.1s ease-out;
        }
        
        .slot-name {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- User Info Bar -->
        <div class="alert alert-info mb-3 d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-user-circle me-2"></i>
                <strong id="currentUsername">...</strong>
            </div>
            <div>
                <span class="badge bg-success me-2">
                    <i class="fas fa-circle me-1"></i>
                    <span id="onlineCount">0</span> Online
                </span>
                <button class="btn btn-sm btn-outline-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
        
        <h1 class="text-center text-white mb-4 animate__animated animate__bounceInDown">
            üé≤ L·∫Øc X√≠ Ng·∫ßu ƒê·ªï R√°c üóëÔ∏è
        </h1>
        
        <!-- Server Status -->
        <div id="serverStatus" class="alert alert-success text-center mb-4">
            <i class="fas fa-circle-check me-2"></i>ƒêang k·∫øt n·ªëi...
        </div>
        
        <!-- Online Users -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h6 class="mb-2">
                    <i class="fas fa-users me-2"></i>Ng∆∞·ªùi ƒëang xem:
                </h6>
                <div id="onlineUsersList" class="d-flex flex-wrap gap-2">
                    <span class="badge bg-secondary">ƒêang t·∫£i...</span>
                </div>
            </div>
        </div>
        
        <!-- Main Dice Card -->
        <div class="card shadow-lg mb-4 animate__animated animate__fadeInUp">
            <div class="card-body text-center py-5">
                <!-- Dice -->
                <div class="dice-container mb-4">
                    <div class="dice" id="dice" onclick="rollDice()">üé≤</div>
                </div>
                
                <!-- Slot Machine for names -->
                <div class="slot-machine mb-4 d-none" id="slotMachine">
                    <div class="slot-names" id="slotNames">
                        <!-- Names will be populated here -->
                    </div>
                </div>
                
                <!-- Selected Person -->
                <div id="selectedPerson" class="mb-4">
                    <p class="text-muted mb-2">B·∫•m v√†o x√≠ ng·∫ßu ƒë·ªÉ l·∫Øc!</p>
                    <div class="selected-person" id="selectedName">???</div>
                </div>
                
                <!-- Reminder Count -->
                <div id="reminderInfo" class="mb-4 d-none">
                    <span class="badge bg-warning text-dark fs-6" id="reminderBadge">
                        <i class="fas fa-bell me-1"></i>ƒê√£ nh·∫Øc: 0 l·∫ßn
                    </span>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <button class="btn btn-roll" id="btnRoll" onclick="rollDice()">
                        <i class="fas fa-dice me-2"></i>L·∫ÆC X√ç NG·∫¶U
                    </button>
                    <button class="btn btn-warning btn-lg d-none" id="btnRemind" onclick="sendReminder()">
                        <i class="fas fa-bullhorn me-2"></i>Nh·∫Øc nh·ªü
                    </button>
                    <button class="btn btn-confirm d-none" id="btnConfirm" onclick="confirmDone()">
                        <i class="fas fa-check-circle me-2"></i>X√°c nh·∫≠n ƒë√£ ƒë·ªï
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-sync-alt fa-2x mb-2"></i>
                        <h3 id="roundNumber">1</h3>
                        <p class="mb-0">V√≤ng</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card bg-success text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <h3 id="totalMembers">0</h3>
                        <p class="mb-0">Th√†nh vi√™n</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card bg-info text-white h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-trophy fa-2x mb-2"></i>
                        <h3 id="totalCompleted">0</h3>
                        <p class="mb-0">ƒê√£ ƒë·ªï r√°c</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Members List -->
        <div class="card shadow mb-4 animate__animated animate__fadeInUp">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Danh s√°ch th√†nh vi√™n</h5>
            </div>
            <div class="card-body">
                <div class="row" id="membersList">
                    <!-- Members will be loaded here -->
                </div>
                
                <hr>
                
                <div class="input-group">
                    <input type="text" class="form-control form-control-lg" id="newMemberName" 
                           placeholder="Nh·∫≠p t√™n th√†nh vi√™n m·ªõi...">
                    <button class="btn btn-success btn-lg" onclick="addMember()">
                        <i class="fas fa-plus me-1"></i>Th√™m
                    </button>
                </div>
            </div>
        </div>
        
        <!-- History -->
        <div class="card shadow animate__animated animate__fadeInUp">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>L·ªãch s·ª≠ ƒë·ªï r√°c</h5>
                <button class="btn btn-outline-danger btn-sm" onclick="resetStatus()">
                    <i class="fas fa-redo me-1"></i>Reset
                </button>
            </div>
            <div class="card-body">
                <div id="historyList">
                    <p class="text-muted text-center">Ch∆∞a c√≥ l·ªãch s·ª≠</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Data t·ª´ server
        let data = {
            members: [],
            currentRound: 1,
            history: [],
            selectedPerson: null,  // Ng∆∞·ªùi ƒëang ƒë∆∞·ª£c ch·ªçn
            reminderCount: 0,
            isWaitingConfirm: false,  // ƒêang ch·ªù x√°c nh·∫≠n
            onlineUsers: []
        };
        
        const diceEmojis = ['üé≤', 'üéØ', 'üé∞', 'üé±', 'üé™', 'üé≠'];
        let ws = null;
        let currentUsername = '';
        let userId = '';
        let isRolling = false; // Flag ƒë·ªÉ tr√°nh double roll
        
        // Load data khi m·ªü trang
        document.addEventListener('DOMContentLoaded', () => {
            // Check if logged in
            currentUsername = sessionStorage.getItem('username');
            if (!currentUsername) {
                window.location.href = '/login.html';
                return;
            }
            
            // Display username
            document.getElementById('currentUsername').textContent = currentUsername;
            
            // Connect WebSocket
            connectWebSocket();
            
            // Enter key ƒë·ªÉ th√™m member
            document.getElementById('newMemberName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addMember();
            });
        });
        
        // ========== WEBSOCKET ==========
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                updateServerStatus(true, 'ƒê√£ k·∫øt n·ªëi WebSocket ‚úì');
                
                // Send login
                ws.send(JSON.stringify({
                    type: 'login',
                    username: currentUsername
                }));
            };
            
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('WebSocket message error:', error);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateServerStatus(false, 'L·ªói WebSocket!');
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateServerStatus(false, 'M·∫•t k·∫øt n·ªëi! ƒêang k·∫øt n·ªëi l·∫°i...');
                
                // Reconnect after 3 seconds
                setTimeout(() => {
                    connectWebSocket();
                }, 3000);
            };
        }
        
        function handleWebSocketMessage(message) {
            console.log('WebSocket message:', message);
            
            switch(message.type) {
                case 'init':
                    // Initial data
                    data = message.data;
                    userId = message.userId;
                    renderAll();
                    break;
                    
                case 'dataUpdate':
                    // Data updated
                    data = message.data;
                    renderAll();
                    break;
                    
                case 'onlineUsers':
                    // Online users updated
                    data.onlineUsers = message.users;
                    renderOnlineUsers();
                    break;
                    
                case 'rolling':
                    // Rolling animation started
                    if (!isRolling) {
                        animateRolling(message.eligibleMembers, message.selectedPerson);
                    }
                    break;
                    
                case 'rollResult':
                    // Roll completed
                    data = message.data;
                    isRolling = false;
                    renderAll();
                    showToast(`üé≤ ${message.selectedPerson.name} ƒë∆∞·ª£c ch·ªçn ƒë·ªï r√°c!`, 'success');
                    break;
                    
                case 'completed':
                    showToast(`‚úÖ ${message.person} ƒë√£ ƒë·ªï r√°c xong!`, 'success');
                    break;
            }
        }
        
        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                sessionStorage.removeItem('username');
                sessionStorage.removeItem('loginTime');
                if (ws) {
                    ws.close();
                }
                window.location.href = '/login.html';
            }
        }
        
        // ========== API CALLS ==========
        
        async function loadData() {
            try {
                const res = await fetch('/api/data');
                data = await res.json();
                renderAll();
                updateServerStatus(true, 'ƒê√£ k·∫øt n·ªëi ‚úì');
            } catch (error) {
                console.error('Error loading data:', error);
                updateServerStatus(false, 'L·ªói k·∫øt n·ªëi!');
            }
        }
        
        async function saveData() {
            try {
                await fetch('/api/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (error) {
                console.error('Error saving data:', error);
                showToast('L·ªói l∆∞u d·ªØ li·ªáu!', 'danger');
            }
        }
        
        function updateServerStatus(connected, message) {
            const el = document.getElementById('serverStatus');
            if (connected) {
                el.className = 'alert alert-success text-center mb-4';
                el.innerHTML = `<i class="fas fa-circle-check me-2"></i>${message || 'ƒê√£ k·∫øt n·ªëi ‚úì'}`;
            } else {
                el.className = 'alert alert-danger text-center mb-4';
                el.innerHTML = `<i class="fas fa-circle-xmark me-2"></i>${message || 'L·ªói k·∫øt n·ªëi!'}`;
            }
        }
        
        // ========== DICE ROLLING ==========
        
        async function rollDice() {
            if (!data.members || data.members.length === 0) {
                showToast('Ch∆∞a c√≥ th√†nh vi√™n n√†o!', 'warning');
                return;
            }
            
            if (data.isWaitingConfirm) {
                showToast('Ph·∫£i x√°c nh·∫≠n ng∆∞·ªùi hi·ªán t·∫°i ƒë√£ ƒë·ªï r√°c tr∆∞·ªõc!', 'warning');
                document.getElementById('btnConfirm').classList.add('shake');
                setTimeout(() => document.getElementById('btnConfirm').classList.remove('shake'), 500);
                return;
            }
            
            // Ki·ªÉm tra xem c√≥ ai ƒëang quay kh√¥ng (server side check)
            if (data.isRolling) {
                showToast('C√≥ ng∆∞·ªùi kh√°c ƒëang quay, vui l√≤ng ƒë·ª£i!', 'warning');
                return;
            }
            
            if (isRolling) {
                return; // Local check
            }
            
            isRolling = true;
            
            const btnRoll = document.getElementById('btnRoll');
            btnRoll.disabled = true;
            btnRoll.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang quay...';
            
            // Call API to roll (server will handle the logic and broadcast)
            try {
                const res = await fetch('/api/roll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ viewer: currentUsername })
                });
                
                const result = await res.json();
                
                if (!result.success) {
                    showToast(result.error || 'C√≥ l·ªói x·∫£y ra!', 'danger');
                    isRolling = false;
                    btnRoll.disabled = false;
                    btnRoll.innerHTML = '<i class="fas fa-dice me-2"></i>L·∫ÆC X√ç NG·∫¶U';
                }
                // If success, WebSocket will handle the animation and result
            } catch (error) {
                console.error('Roll error:', error);
                showToast('L·ªói k·∫øt n·ªëi!', 'danger');
                isRolling = false;
                btnRoll.disabled = false;
                btnRoll.innerHTML = '<i class="fas fa-dice me-2"></i>L·∫ÆC X√ç NG·∫¶U';
            }
        }
        
        // Animation function triggered by WebSocket
        function animateRolling(eligibleMembers, finalPerson) {
            const dice = document.getElementById('dice');
            const btnRoll = document.getElementById('btnRoll');
            
            // Start rolling animation
            dice.classList.add('rolling');
            
            // Slot machine effect
            const slotMachine = document.getElementById('slotMachine');
            const slotNames = document.getElementById('slotNames');
            const selectedNameEl = document.getElementById('selectedName');
            
            slotMachine.classList.remove('d-none');
            selectedNameEl.textContent = '';
            
            // Populate slot with eligible members only
            let slotHTML = '';
            for (let i = 0; i < 20; i++) {
                const randomMember = eligibleMembers[Math.floor(Math.random() * eligibleMembers.length)];
                slotHTML += `<div class="slot-name">${randomMember.name}</div>`;
            }
            slotNames.innerHTML = slotHTML;
            
            // Animate slot
            let offset = 0;
            const totalHeight = 20 * 80;
            const duration = 3000;
            const startTime = Date.now();
            
            function animateSlot() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function (ease out)
                const easeOut = 1 - Math.pow(1 - progress, 3);
                
                offset = easeOut * (totalHeight - 80);
                slotNames.style.transform = `translateY(-${offset}px)`;
                
                // Change dice emoji
                dice.textContent = diceEmojis[Math.floor(Math.random() * diceEmojis.length)];
                
                if (progress < 1) {
                    requestAnimationFrame(animateSlot);
                } else {
                    // Animation done
                    dice.classList.remove('rolling');
                    dice.textContent = 'üé≤';
                    slotMachine.classList.add('d-none');
                    
                    // Show selected person
                    selectedNameEl.textContent = finalPerson.name;
                    selectedNameEl.classList.add('animate__animated', 'animate__bounceIn');
                    setTimeout(() => selectedNameEl.classList.remove('animate__animated', 'animate__bounceIn'), 1000);
                    
                    // Show buttons
                    document.getElementById('btnRoll').classList.add('d-none');
                    document.getElementById('btnRoll').innerHTML = '<i class="fas fa-dice me-2"></i>L·∫ÆC X√ç NG·∫¶U';
                    document.getElementById('btnRemind').classList.remove('d-none');
                    document.getElementById('btnConfirm').classList.remove('d-none');
                    document.getElementById('reminderInfo').classList.remove('d-none');
                    
                    renderMembers();
                }
            }
            
            requestAnimationFrame(animateSlot);
        }
        
        // ========== ACTIONS ==========
        
        async function sendReminder() {
            if (!data.selectedPerson) return;
            
            try {
                const res = await fetch('/api/remind', { method: 'POST' });
                const result = await res.json();
                
                if (result.success) {
                    data = result.data;
                    updateReminderBadge();
                    showToast(result.message, 'success');
                } else {
                    showToast(result.error || 'C√≥ l·ªói!', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('L·ªói k·∫øt n·ªëi server!', 'danger');
            }
        }
        
        async function confirmDone() {
            if (!data.selectedPerson) return;
            
            try {
                const res = await fetch('/api/confirm', { method: 'POST' });
                const result = await res.json();
                
                if (result.success) {
                    // WebSocket will handle UI update
                } else {
                    showToast(result.error || 'C√≥ l·ªói!', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('L·ªói k·∫øt n·ªëi server!', 'danger');
            }
        }
        
        async function addMember() {
            const input = document.getElementById('newMemberName');
            const name = input.value.trim();
            
            if (!name) {
                showToast('Vui l√≤ng nh·∫≠p t√™n!', 'warning');
                return;
            }
            
            const newId = data.members && data.members.length > 0 
                ? Math.max(...data.members.map(m => m.id)) + 1 
                : 1;
            
            data.members = data.members || [];
            data.members.push({ id: newId, name: name });
            input.value = '';
            
            await saveData();
            renderAll();
            showToast(`ƒê√£ th√™m ${name}!`, 'success');
        }
        
        async function removeMember(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√†nh vi√™n n√†y?')) return;
            
            data.members = data.members.filter(m => m.id !== id);
            
            await saveData();
            renderAll();
            showToast('ƒê√£ x√≥a th√†nh vi√™n!', 'success');
        }
        
        async function resetStatus() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset l·∫°i t·ª´ ƒë·∫ßu? L·ªãch s·ª≠ s·∫Ω b·ªã x√≥a.')) return;
            
            try {
                const res = await fetch('/api/reset', { method: 'POST' });
                const result = await res.json();
                
                if (result.success) {
                    data = result.data;
                    
                    // Reset UI
                    document.getElementById('selectedName').textContent = '???';
                    document.getElementById('btnRoll').classList.remove('d-none');
                    document.getElementById('btnRoll').disabled = false;
                    document.getElementById('btnRemind').classList.add('d-none');
                    document.getElementById('btnConfirm').classList.add('d-none');
                    document.getElementById('reminderInfo').classList.add('d-none');
                    
                    renderAll();
                    showToast('ƒê√£ reset th√†nh c√¥ng!', 'success');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('L·ªói k·∫øt n·ªëi server!', 'danger');
            }
        }
        
        // ========== RENDER ==========
        
        function renderAll() {
            renderStats();
            renderMembers();
            renderHistory();
            renderOnlineUsers();
            updateUIState();
        }
        
        function renderOnlineUsers() {
            const container = document.getElementById('onlineUsersList');
            const countEl = document.getElementById('onlineCount');
            
            if (!data.onlineUsers || data.onlineUsers.length === 0) {
                container.innerHTML = '<span class="badge bg-secondary">Ch∆∞a c√≥ ai online</span>';
                countEl.textContent = '0';
                return;
            }
            
            countEl.textContent = data.onlineUsers.length;
            
            container.innerHTML = data.onlineUsers.map(user => {
                const isMe = user === currentUsername;
                return `<span class="badge ${isMe ? 'bg-primary' : 'bg-secondary'} fs-6">
                    <i class="fas fa-user me-1"></i>${user}${isMe ? ' (B·∫°n)' : ''}
                </span>`;
            }).join('');
        }
        
        function renderStats() {
            document.getElementById('roundNumber').textContent = data.currentRound || 1;
            document.getElementById('totalMembers').textContent = data.members ? data.members.length : 0;
            document.getElementById('totalCompleted').textContent = data.history ? data.history.length : 0;
        }
        
        function updateUIState() {
            const btnRoll = document.getElementById('btnRoll');
            
            if (data.isWaitingConfirm && data.selectedPerson) {
                document.getElementById('selectedName').textContent = data.selectedPerson.name;
                btnRoll.classList.add('d-none');
                document.getElementById('btnRemind').classList.remove('d-none');
                document.getElementById('btnConfirm').classList.remove('d-none');
                document.getElementById('reminderInfo').classList.remove('d-none');
                updateReminderBadge();
            } else {
                document.getElementById('selectedName').textContent = '???';
                btnRoll.classList.remove('d-none');
                
                // Disable button n·∫øu c√≥ ng∆∞·ªùi ƒëang quay
                if (data.isRolling) {
                    btnRoll.disabled = true;
                    btnRoll.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang quay...';
                } else {
                    btnRoll.disabled = false;
                    btnRoll.innerHTML = '<i class="fas fa-dice me-2"></i>L·∫ÆC X√ç NG·∫¶U';
                }
                
                document.getElementById('btnRemind').classList.add('d-none');
                document.getElementById('btnConfirm').classList.add('d-none');
                document.getElementById('reminderInfo').classList.add('d-none');
            }
        }
        
        function updateReminderBadge() {
            const badge = document.getElementById('reminderBadge');
            const count = data.reminderCount || 0;
            
            badge.innerHTML = `<i class="fas fa-bell me-1"></i>ƒê√£ nh·∫Øc: ${count} l·∫ßn`;
            
            if (count === 0) {
                badge.className = 'badge bg-secondary fs-6';
            } else if (count === 1) {
                badge.className = 'badge bg-warning text-dark fs-6';
            } else if (count === 2) {
                badge.className = 'badge bg-orange fs-6';
                badge.style.background = '#fd7e14';
            } else {
                badge.className = 'badge bg-danger fs-6 animate__animated animate__pulse animate__infinite';
            }
        }
        
        function renderMembers() {
            const container = document.getElementById('membersList');
            
            if (!data.members || data.members.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-4">Ch∆∞a c√≥ th√†nh vi√™n n√†o</div>';
                return;
            }
            
            container.innerHTML = data.members.map(member => {
                const isSelected = data.selectedPerson && data.selectedPerson.id === member.id;
                return `
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card member-card h-100 ${isSelected ? 'selected' : ''}">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="fas fa-user-circle fa-2x text-primary me-2"></i>
                                    <span class="fw-bold">${member.name}</span>
                                    ${isSelected ? '<span class="badge bg-primary ms-2">ƒêang ch·ªù</span>' : ''}
                                </div>
                                <button class="btn btn-outline-danger btn-sm" onclick="removeMember(${member.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (!data.history || data.history.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Ch∆∞a c√≥ l·ªãch s·ª≠</p>';
                return;
            }
            
            const recentHistory = data.history.slice(-10).reverse();
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ng∆∞·ªùi ƒë·ªï</th>
                                <th>V√≤ng</th>
                                <th>S·ªë l·∫ßn nh·∫Øc</th>
                                <th>Th·ªùi gian</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentHistory.map(item => `
                                <tr>
                                    <td><i class="fas fa-user me-2"></i>${item.memberName}</td>
                                    <td><span class="badge bg-primary">V√≤ng ${item.round}</span></td>
                                    <td>
                                        <span class="badge ${item.reminderCount > 2 ? 'bg-danger' : item.reminderCount > 0 ? 'bg-warning text-dark' : 'bg-success'}">
                                            ${item.reminderCount || 0} l·∫ßn
                                        </span>
                                    </td>
                                    <td><small class="text-muted">${new Date(item.timestamp).toLocaleString('vi-VN')}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // ========== TOAST ==========
        
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show animate__animated animate__fadeInRight`;
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('animate__fadeInRight');
                toast.classList.add('animate__fadeOutRight');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
            document.body.appendChild(container);
            return container;
        }
    </script>
</body>
</html>
